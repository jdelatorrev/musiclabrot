<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Autenticación Musical - Acceso Seguro</title>
    <link rel="stylesheet" href="music-styles.css">
</head>
<body>
    <div class="music-container">
        <header class="music-header">
            <h1>MUSIC LAB</h1>
            <p class="welcome-message">Acceso autorizado</p>
            <button class="logout-btn" onclick="logout()">Cerrar Sesión</button>
        </header>

        <div class="music-content">
            <div class="player-section">
                <div class="current-song">
                    <div class="song-info">
                        <h3 id="currentSongTitle">Selecciona una canción</h3>
                        <p id="currentArtist">Artista</p>
                    </div>
                    <div class="album-art">
                        <div class="album-placeholder" aria-hidden="true">
                            <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 3a9 9 0 1 0 9 9 9 9 0 0 0-9-9Zm0 2a7 7 0 1 1-7 7 7 7 0 0 1 7-7Zm0 3a4 4 0 1 0 4 4 4 4 0 0 0-4-4Zm0 2a2 2 0 1 1-2 2 2 2 0 0 1 2-2Z" fill="currentColor"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="player-controls">
                    <button class="control-btn" id="prevBtn" aria-label="Anterior">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M6 5h2v14H6zM20 6v12l-9-6 9-6z"/></svg>
                    </button>
                    <button class="control-btn play-pause" id="playPauseBtn" aria-label="Reproducir/Pausar">
                        <svg class="icon-play" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M8 5v14l11-7L8 5z"/></svg>
                        <svg class="icon-pause" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="display:none"><path d="M6 5h4v14H6zm8 0h4v14h-4z"/></svg>
                    </button>
                    <button class="control-btn" id="nextBtn" aria-label="Siguiente">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M16 5h2v14h-2zM4 6v12l9-6-9-6z"/></svg>
                    </button>
                </div>

                <div class="progress-section">
                    <div class="time-display">
                        <span id="currentTime">0:00</span>
                        <span id="totalTime">0:00</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                        <input type="range" class="progress-slider" id="progressSlider" min="0" max="100" value="0">
                    </div>
                </div>

                <div class="volume-section">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M3 10v4h4l5 5V5L7 10H3zm13.5 2a4.5 4.5 0 0 0-3-4.243v8.486A4.5 4.5 0 0 0 16.5 12zm0-8a10.5 10.5 0 0 1 0 16v-2a8.5 8.5 0 0 0 0-12v-2z"/></svg>
                    <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="50">
                </div>
            </div>

            <div class="playlist-section">
                <h2>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="margin-right:6px;vertical-align:middle"><path d="M12 3v10.55A4 4 0 1 0 14 17V7h4V3h-6z"/></svg>
                    Lista de Reproducción
                </h2>
                <div class="playlist" id="playlist">
                    <!-- Las canciones se cargarán aquí dinámicamente -->
                </div>
            </div>
        </div>

        <footer class="music-footer">
            <p>Sistema de Autenticación Musical - Acceso Seguro</p>
        </footer>
    </div>

    <!-- Audio element (hidden) -->
    <audio id="audioPlayer" preload="metadata"></audio>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      (async function ensureAuth(){
        try {
          const r = await fetch('/api/auth/me', { credentials: 'include' });
          const d = await r.json();
          if (!(r.ok && d && d.authenticated && d.role === 'student')) {
            window.location.href = '/index.html';
          }
        } catch (_) {
          window.location.href = '/index.html';
        }
      })();
      
      // Verificación periódica de sesión (cada 5 segundos)
      // Si el profesor cierra la sesión, el estudiante será desconectado automáticamente
      let sessionCheckInterval = null;
      let consecutiveFailures = 0;
      const MAX_FAILURES = 2; // Permitir 2 fallos consecutivos antes de cerrar sesión
      
      async function checkSessionStatus() {
        try {
          const response = await fetch('/api/auth/session-check', { 
            credentials: 'include',
            cache: 'no-cache'
          });
          const data = await response.json();
          
          if (!response.ok || !data.active) {
            consecutiveFailures++;
            console.warn(`[Session Check] Sesión inactiva detectada (intento ${consecutiveFailures}/${MAX_FAILURES})`);
            
            if (consecutiveFailures >= MAX_FAILURES) {
              // Sesión confirmada como cerrada
              if (sessionCheckInterval) {
                clearInterval(sessionCheckInterval);
              }
              
              // Mostrar mensaje y redirigir
              await Swal.fire({
                icon: 'warning',
                title: 'Sesión cerrada',
                text: 'Tu sesión ha sido cerrada. Serás redirigido al inicio de sesión.',
                confirmButtonText: 'Aceptar',
                allowOutsideClick: false,
                timer: 3000,
                timerProgressBar: true
              });
              
              window.location.href = '/index.html';
            }
          } else {
            // Sesión activa, resetear contador de fallos
            consecutiveFailures = 0;
          }
        } catch (error) {
          consecutiveFailures++;
          console.error('[Session Check] Error al verificar sesión:', error);
          
          if (consecutiveFailures >= MAX_FAILURES) {
            // Error persistente, asumir sesión cerrada
            if (sessionCheckInterval) {
              clearInterval(sessionCheckInterval);
            }
            window.location.href = '/index.html';
          }
        }
      }
      
      // Iniciar verificación periódica cada 5 segundos
      sessionCheckInterval = setInterval(checkSessionStatus, 5000);
      
      // También verificar cuando la ventana recupera el foco
      window.addEventListener('focus', checkSessionStatus);
      
      async function logout(){
        // Detener verificación de sesión
        if (sessionCheckInterval) {
          clearInterval(sessionCheckInterval);
        }
        try { await fetch('/api/auth/logout', { method:'POST' }); } catch(_){ }
        window.location.href = '/index.html';
      }
    </script>
    <script src="music-player.js"></script>
</body>
</html>