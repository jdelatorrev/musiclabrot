<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Usuarios Registrados</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f5f7fb; margin:0; }
    header { background: linear-gradient(135deg, #2c3e50, #34495e); color:#fff; padding:20px 24px; }
    header h1 { margin:0; font-size:20px; }
    header a { color:#fff; text-decoration:none; padding:8px 16px; background:rgba(255,255,255,0.15); border-radius:6px; transition:background 0.2s; display:inline-block; }
    header a:hover { background:rgba(255,255,255,0.25); }
    .container { max-width: 1100px; margin: 20px auto; padding: 0 16px; }
    .toolbar { display:flex; gap:8px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    .toolbar input { padding:8px; border:1px solid #ddd; border-radius:6px; min-width:200px; flex:1; }
    .toolbar button { padding:8px 12px; border:none; background:#3498db; color:#fff; border-radius:6px; cursor:pointer; white-space:nowrap; }
    .grid { display:grid; gap:14px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    .card { background:#fff; border:1px solid #eaeaea; border-radius:10px; padding:16px; box-shadow: 0 4px 14px rgba(0,0,0,.04); }
    .row { display:flex; justify-content:space-between; align-items:center; margin:8px 0; gap:8px; }
    .username { font-weight:600; color:#2c3e50; word-break: break-word; overflow-wrap: anywhere; flex:1; min-width:0; }
    .meta { color:#7f8c8d; font-size:12px; }
    .meta-row { display:flex; flex-direction:column; gap:4px; margin:8px 0; color:#7f8c8d; font-size:12px; }
    .badge { display:inline-block; padding:4px 10px; border-radius:999px; font-size:11px; color:#fff; white-space:nowrap; flex-shrink:0; }
    .badge.ok { background:#27ae60; }
    .badge.no { background:#e74c3c; }
    .empty { text-align:center; color:#7f8c8d; padding:30px; }
    .actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; flex-wrap:wrap; }
    .btn { padding:8px 14px; border:none; border-radius:6px; cursor:pointer; font-size:13px; white-space:nowrap; }
    .btn.save { background:#27ae60; color:#fff; }
    .btn.save:hover { background:#229954; }
    .btn.delete { background:#e74c3c; color:#fff; }
    .btn.delete:hover { background:#c0392b; }
    .form-section { margin:12px 0; padding:12px; background:#f8f9fa; border-radius:8px; }
    .form-group { margin-bottom:10px; }
    .form-group:last-child { margin-bottom:0; }
    .form-label { display:block; font-size:12px; font-weight:600; color:#34495e; margin-bottom:6px; }
    .inline-input { padding:8px; border:1px solid #ddd; border-radius:6px; width:100%; font-size:14px; transition:border-color 0.2s, box-shadow 0.2s; }
    .inline-input:focus { outline:none; border-color:#3498db; box-shadow:0 0 0 3px rgba(52,152,219,0.1); }
    .checkbox-wrapper { display:flex; align-items:center; gap:8px; }
    .checkbox-wrapper input[type="checkbox"] { width:18px; height:18px; cursor:pointer; accent-color:#27ae60; }
    
    /* Responsivo para pantallas peque√±as */
    @media (max-width: 768px) {
      .grid { grid-template-columns: 1fr; }
      .toolbar { flex-direction: column; align-items: stretch; }
      .toolbar input { width: 100%; }
      header h1 { font-size: 18px; }
    }
    
    /* Transiciones suaves */
    .btn { transition: all 0.2s ease; }
    .btn:active { transform: scale(0.95); }
    .card { transition: box-shadow 0.2s ease; }
    .card:hover { box-shadow: 0 6px 20px rgba(0,0,0,.08); }
  </style>
</head>
<body>
  <header>
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
      <h1>üë• Usuarios Registrados</h1>
      <a href="/profesor.html" title="Volver al panel">‚Üê Volver al panel</a>
    </div>
  </header>
  <div class="container">
    <div class="toolbar">
      <input id="search" placeholder="Buscar usuario..." />
      <button id="refresh">Actualizar</button>
      <span class="meta" id="count"></span>
    </div>
    <div id="users" class="grid"></div>
    <div id="empty" class="empty" style="display:none;">No hay usuarios registrados.</div>
  </div>

  <script>
    (function(){
      try {
        const _f = window.fetch;
        window.fetch = function(input, init){
          init = init || {};
          init.headers = Object.assign({ 'Accept':'application/json' }, init.headers || {});
          return _f(input, init);
        }
      } catch(_) {}
    })();
    async function fetchJSON(url, options){
      const resp = await fetch(url, options);
      const ct = (resp.headers && resp.headers.get('content-type')) || '';
      if (!ct.includes('application/json')) {
        const txt = await resp.text();
        throw new Error('Respuesta no JSON: ' + txt.slice(0, 200));
      }
      return resp.json();
    }
    let isProfessorAuth = false;
    async function checkProfessorAuth(){
      try {
        const d = await fetchJSON('/api/auth/me');
        isProfessorAuth = !!(d && d.authenticated && d.role === 'professor');
        if (!isProfessorAuth) window.location.href = '/profesor-login';
        return isProfessorAuth;
      } catch(_) { return false; }
    }

    function render(list){
      const grid = document.getElementById('users');
      const empty = document.getElementById('empty');
      const count = document.getElementById('count');
      count.textContent = `${list.length} usuario(s)`;
      if (!list.length){
        grid.innerHTML = '';
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';
      grid.innerHTML = list.map(u => `
        <div class="card">
          <div class="row">
            <div class="username">${u.username}</div>
            <span class="badge ${u.granted? 'ok':'no'}">${u.granted? 'ACCESO':'SIN ACCESO'}</span>
          </div>
          <div class="meta-row">
            <div>üìÖ Creado: ${new Date(u.created_at).toLocaleString('es-ES', {dateStyle:'short', timeStyle:'short'})}</div>
          </div>
          <div class="form-section">
            <div class="form-group">
              <label class="form-label">üîë Nueva contrase√±a (opcional)</label>
              <input id="pwd-${u.username}" class="inline-input" type="password" placeholder="Dejar vac√≠o para no cambiar" />
            </div>
            <div class="form-group">
              <label class="form-label">üîì Estado de acceso</label>
              <div class="checkbox-wrapper">
                <input id="gr-${u.username}" type="checkbox" ${u.granted? 'checked':''} />
                <label for="gr-${u.username}" style="margin:0;cursor:pointer;font-size:13px;color:#34495e;">Conceder acceso al usuario</label>
              </div>
            </div>
          </div>
          <div class="actions">
            <button class="btn save" onclick="saveUser('${u.username}')">üíæ Guardar</button>
            <button class="btn delete" onclick="deleteUser('${u.username}')">üóëÔ∏è Eliminar</button>
          </div>
        </div>
      `).join('');
    }

    async function load(){
      if (!isProfessorAuth && !(await checkProfessorAuth())) return;
      let items = await fetchJSON('/api/professor/users');
      const q = document.getElementById('search').value.trim().toLowerCase();
      if (q) items = items.filter(x => (x.username||'').toLowerCase().includes(q));
      render(items);
    }

    async function saveUser(username){
      if (!isProfessorAuth && !(await checkProfessorAuth())) return;
      const pwdEl = document.getElementById(`pwd-${username}`);
      const grEl = document.getElementById(`gr-${username}`);
      const body = {
        password: pwdEl && pwdEl.value ? pwdEl.value : undefined,
        granted: grEl ? !!grEl.checked : undefined
      };
      const resp = await fetch(`/api/professor/users/${encodeURIComponent(username)}`, {
        method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
      });
      const data = await resp.json();
      if (resp.ok && data && data.success) {
        if (pwdEl) pwdEl.value = '';
        load();
      } else {
        alert(data.message || 'No se pudo actualizar');
      }
    }

    async function deleteUser(username){
      if (!isProfessorAuth && !(await checkProfessorAuth())) return;
      if (!confirm(`¬øEliminar usuario ${username}?`)) return;
      const resp = await fetch(`/api/professor/users/${encodeURIComponent(username)}`, { method: 'DELETE' });
      const data = await resp.json();
      if (resp.ok && data && data.success) {
        load();
      } else {
        alert(data.message || 'No se pudo eliminar');
      }
    }

    document.getElementById('refresh').addEventListener('click', load);
    document.getElementById('search').addEventListener('input', load);

    // Auto refresco cada 10s
    setInterval(load, 10000);

    // Primera carga
    load();
  </script>
</body>
</html>
